{% extends "base.html" %}
{% load i18n %}
{% load card_filters %}

{% block title %}EMTEEGEE - Magic: The Gathering Analysis Platform{% endblock %}

{% block content %}
<div class="container-xxl">
    <!-- Hero Section -->
    <div class="hero-home-section">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <div class="hero-content">
                    <h1 class="hero-home-title">
                        <span class="brand-icon">ðŸŽ´</span>
                        <span class="brand-name">EMTEEGEE</span>
                    </h1>
                    <p class="hero-subtitle">Advanced Magic: The Gathering Analysis Platform</p>
                    <p class="hero-description">
                        Discover deeper insights into your favorite MTG cards with AI-powered analysis, 
                        comprehensive card data, and intelligent deck building recommendations.
                    </p>                    <div class="hero-actions">
                        {% if user.is_authenticated %}
                            <a href="/abyss/" class="btn btn-primary btn-lg me-3">
                                <i class="bi bi-grid-3x3-gap"></i> The Abyss
                            </a>
                            <button type="button" class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" data-bs-target="#quickSearchModal">
                                <i class="bi bi-search"></i> Quick Search
                            </button>
                        {% else %}
                            <a href="/abyss/" class="btn btn-primary btn-lg me-3">
                                <i class="bi bi-grid-3x3-gap"></i> The Abyss
                            </a>
                            <a href="{% url 'account_login' %}" class="btn btn-outline-primary btn-lg">
                                <i class="bi bi-box-arrow-in-right"></i> Get Started
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="hero-stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="bi bi-collection"></i></div>
                        <div class="stat-content">
                            <div class="stat-number">{{ card_count|default:"32,000+" }}</div>
                            <div class="stat-label">Magic Cards</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="bi bi-cpu"></i></div>
                        <div class="stat-content">
                            <div class="stat-number">{{ analysis_progress.analyzed_cards|default:"1,200+" }}</div>
                            <div class="stat-label">AI Analyzed</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="bi bi-graph-up"></i></div>
                        <div class="stat-content">
                            <div class="stat-number">20</div>
                            <div class="stat-label">Analysis Types</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="bi bi-people"></i></div>
                        <div class="stat-content">
                            <div class="stat-number">{{ user_count|default:"500+" }}</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>    <!-- Featured Cards Section -->
    {% if featured_cards %}
    <section class="featured-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-stars"></i> Featured Cards
            </h2>
            <p class="section-subtitle">Discover powerful Magic cards with complete analysis</p>
        </div>
        <div class="row g-4">
            {% for card in featured_cards %}
                <div class="col-lg-4 col-md-6">
                    <div class="featured-card-enhanced">
                        <div class="card-image-enhanced">
                            {% with card|card_image:'normal' as card_image_url %}
                                {% if card_image_url %}
                                    <img src="{{ card_image_url }}" alt="{{ card.name }}" class="featured-card-image-enhanced">
                                {% else %}
                                    <div class="featured-card-placeholder-enhanced">
                                        <i class="bi bi-image"></i>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="featured-card-info-enhanced">
                            <h3 class="card-name-enhanced">{{ card.name }}</h3>
                            {% if card.rarity %}
                                <span class="rarity-dot-enhanced {{ card.rarity }}"></span>
                            {% endif %}
                        </div>
                        <a href="{% url 'cards:card_detail' card.uuid %}" class="featured-card-link-enhanced">
                            <div class="card-overlay-enhanced">
                                <i class="bi bi-eye-fill"></i>
                                <span>View Card</span>
                            </div>
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}    <!-- Recent Cards Section -->
    {% if recent_cards %}
    <section class="recent-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-clock-history"></i> Recently Added
            </h2>
            <p class="section-subtitle">Latest cards in our collection</p>
        </div>
        <div class="row g-3">
            {% for card in recent_cards %}
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                    <div class="recent-card-enhanced">
                        <div class="recent-card-image-enhanced">
                            {% with card|card_image:'normal' as card_image_url %}
                                {% if card_image_url %}
                                    <img src="{{ card_image_url }}" alt="{{ card.name }}">
                                {% else %}
                                    <div class="recent-card-placeholder-enhanced">
                                        <i class="bi bi-image"></i>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="recent-card-info-enhanced">
                            <h4 class="recent-card-name-enhanced">{{ card.name }}</h4>
                        </div>
                        <a href="{% url 'cards:card_detail' card.uuid %}" class="recent-card-overlay-enhanced">
                            <div class="recent-overlay-content">
                                <i class="bi bi-eye-fill"></i>
                            </div>
                        </a>
                    </div>
                </div>
            {% endfor %}        </div>
    </section>
    {% endif %}

    <!-- Features Section -->
    <section class="features-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-lightning"></i> Platform Features
            </h2>
            <p class="section-subtitle">Everything you need for MTG analysis and deck building</p>
        </div>
        <div class="row g-4">
            <div class="col-lg-4 col-md-6">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-robot"></i>
                    </div>
                    <h3 class="feature-title">AI Analysis</h3>
                    <p class="feature-description">
                        Get deep insights with 20 different AI analysis types including tactical analysis, 
                        combo suggestions, and power level assessments.
                    </p>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-database"></i>
                    </div>
                    <h3 class="feature-title">Complete Database</h3>
                    <p class="feature-description">
                        Access comprehensive data on all Magic cards with images, pricing, 
                        legalities, and real-time market information.
                    </p>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <h3 class="feature-title">Market Insights</h3>
                    <p class="feature-description">
                        Track card values with international pricing (USD/EUR), EDHREC rankings, 
                        and investment outlook analysis.
                    </p>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-layers"></i>
                    </div>
                    <h3 class="feature-title">Deck Building</h3>
                    <p class="feature-description">
                        Build better decks with synergy analysis, archetype recommendations, 
                        and meta positioning insights.
                    </p>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-search"></i>
                    </div>
                    <h3 class="feature-title">Advanced Search</h3>
                    <p class="feature-description">
                        Find exactly what you need with powerful filtering by format, 
                        color, type, rarity, and analysis completion.
                    </p>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <h3 class="feature-title">Format Legality</h3>
                    <p class="feature-description">
                        Stay compliant with up-to-date format legality information 
                        for Standard, Modern, Legacy, and Commander.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- CTA Section -->
    {% if not user.is_authenticated %}
    <section class="cta-section">
        <div class="cta-content">
            <h2 class="cta-title">Ready to Level Up Your MTG Game?</h2>
            <p class="cta-description">
                Join thousands of players using EMTEEGEE to build better decks, 
                understand the meta, and make smarter card choices.
            </p>
            <div class="cta-actions">
                <a href="{% url 'account_signup' %}" class="btn btn-primary btn-lg">
                    <i class="bi bi-person-plus"></i> Sign Up Free
                </a>
                <a href="{% url 'account_login' %}" class="btn btn-link btn-lg">
                    Already have an account? <strong>Sign In</strong>
                </a>
            </div>
        </div>
    </section>
    {% endif %}
</div>

<!-- Quick Search Modal -->
<div class="modal fade" id="quickSearchModal" tabindex="-1" aria-labelledby="quickSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="quickSearchModalLabel">
                    <i class="bi bi-search"></i> Quick Card Search
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>            <div class="modal-body">
                <form id="quickSearchForm" action="/abyss/" method="get">
                    <div class="mb-3">
                        <label for="cardNameSearch" class="form-label">Search Cards</label>
                        <div class="position-relative">
                            <input type="text" class="form-control form-control-lg" id="cardNameSearch" name="q" 
                                   placeholder="Search by name, text, type, artist, set, or any card details..." 
                                   autocomplete="off">
                            <div class="autocomplete-dropdown" id="modal-autocomplete-dropdown"></div>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-lightbulb text-warning"></i>
                            <strong>Pro tip:</strong> Search for anything - card names, abilities, flavor text, artists, sets, keywords, or even partial matches!
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Powerful Search:</strong> Try searches like "draw cards", "Lightning", "Urza", "enters the battlefield", 
                        "MH3", or even "Rebecca Guay" to find cards by artist.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="submit" form="quickSearchForm" class="btn btn-primary">
                    <i class="bi bi-search"></i> Search The Abyss
                </button>
            </div>
        </div>    </div>
</div>

<script>
// Autocomplete functionality for Quick Search Modal
document.addEventListener('DOMContentLoaded', function() {
    const modalSearchInput = document.getElementById('cardNameSearch');
    const modalDropdown = document.getElementById('modal-autocomplete-dropdown');
    let modalCurrentRequest = null;
    let modalSelectedIndex = -1;
    let modalSuggestions = [];
    
    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Show modal autocomplete suggestions
    function showModalSuggestions(query) {
        if (query.length < 2) {
            hideModalDropdown();
            return;
        }
        
        if (modalCurrentRequest) {
            modalCurrentRequest.abort();
        }
        
        modalDropdown.innerHTML = '<div class="autocomplete-loading"><i class="bi bi-three-dots"></i> Searching...</div>';
        modalDropdown.classList.add('show');
        
        modalCurrentRequest = new AbortController();
        fetch(`/api/autocomplete/?q=${encodeURIComponent(query)}`, {
            signal: modalCurrentRequest.signal
        })
        .then(response => response.json())
        .then(data => {
            modalSuggestions = data.suggestions || [];
            renderModalSuggestions(modalSuggestions);
        })
        .catch(error => {
            if (error.name !== 'AbortError') {
                console.error('Modal autocomplete error:', error);
                hideModalDropdown();
            }
        })
        .finally(() => {
            modalCurrentRequest = null;
        });
    }
    
    // Render modal suggestions
    function renderModalSuggestions(suggestions) {
        if (!suggestions.length) {
            modalDropdown.innerHTML = '<div class="autocomplete-no-results">No suggestions found</div>';
            modalDropdown.classList.add('show');
            return;
        }
          let html = '';
        suggestions.forEach((suggestion, index) => {
            const uuid = suggestion.uuid ? `data-uuid="${escapeHtml(suggestion.uuid)}"` : '';
            const suggestionType = suggestion.type || 'other';
            html += `
                <div class="autocomplete-item" data-index="${index}" data-text="${escapeHtml(suggestion.text)}" data-type="${suggestionType}" ${uuid}>
                    <i class="bi ${suggestion.icon} autocomplete-icon"></i>
                    <span class="autocomplete-text">${escapeHtml(suggestion.text)}</span>
                    <span class="autocomplete-category">${escapeHtml(suggestion.category)}</span>
                </div>
            `;
        });
        
        modalDropdown.innerHTML = html;
        modalDropdown.classList.add('show');
        modalSelectedIndex = -1;
        
        modalDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', function() {
                const suggestionType = this.getAttribute('data-type');
                const uuid = this.getAttribute('data-uuid');
                const text = this.getAttribute('data-text');
                
                hideModalDropdown();
                  // If it's a card suggestion with UUID, go directly to card detail
                if (suggestionType === 'card' && uuid) {
                    // Close modal first
                    const modal = bootstrap.Modal.getInstance(document.getElementById('quickSearchModal'));
                    if (modal) modal.hide();
                    // Navigate to card
                    window.location.href = `/card/${uuid}/`;
                } else {
                    // For other suggestions, do a search in The Abyss
                    modalSearchInput.value = text;
                    document.getElementById('quickSearchForm').submit();
                }
            });
        });
    }
    
    // Hide modal dropdown
    function hideModalDropdown() {
        modalDropdown.classList.remove('show');
        modalDropdown.innerHTML = '';
        modalSelectedIndex = -1;
    }
    
    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Handle modal keyboard navigation
    function handleModalKeyboardNavigation(e) {
        const items = modalDropdown.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            modalSelectedIndex = Math.min(modalSelectedIndex + 1, items.length - 1);
            updateModalSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            modalSelectedIndex = Math.max(modalSelectedIndex - 1, -1);
            updateModalSelection(items);
        } else if (e.key === 'Enter') {
            if (modalSelectedIndex >= 0 && modalSelectedIndex < items.length) {
                e.preventDefault();
                const selectedItem = items[modalSelectedIndex];
                const text = selectedItem.getAttribute('data-text');
                modalSearchInput.value = text;
                hideModalDropdown();
                document.getElementById('quickSearchForm').submit();
            }
        } else if (e.key === 'Escape') {
            hideModalDropdown();
        }
    }
    
    // Update modal selection
    function updateModalSelection(items) {
        items.forEach((item, index) => {
            item.classList.toggle('active', index === modalSelectedIndex);
        });
    }
    
    // Debounced modal search
    const debouncedModalSearch = debounce(showModalSuggestions, 300);
    
    // Modal event listeners
    if (modalSearchInput) {
        modalSearchInput.addEventListener('input', function() {
            const query = this.value.trim();
            debouncedModalSearch(query);
        });
        
        modalSearchInput.addEventListener('keydown', handleModalKeyboardNavigation);
        
        modalSearchInput.addEventListener('focus', function() {
            const query = this.value.trim();
            if (query.length >= 2) {
                showModalSuggestions(query);
            }
        });
    }
    
    // Hide modal dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (modalSearchInput && modalDropdown && 
            !modalSearchInput.contains(e.target) && !modalDropdown.contains(e.target)) {
            hideModalDropdown();
        }
    });
    
    // Clear modal autocomplete when modal is hidden
    document.getElementById('quickSearchModal').addEventListener('hidden.bs.modal', function() {
        hideModalDropdown();
        if (modalSearchInput) {
            modalSearchInput.value = '';
        }
    });
});
</script>

{% endblock %}
